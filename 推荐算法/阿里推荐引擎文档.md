# RecEng产品文档

## 产品概述

推荐服务通常由三部分组成：日志采集，推荐计算和产品对接。

- 首先需要采集产品中记录的用户行为日志到离线存储。
- 在离线环境下利用推荐算法进行用户和物品的匹配计算。
- 找出每个用户可能感兴趣的物品集合后，将这些预先计算好的结果推送到在线存储上。
- 最终产品在有用户访问时通过在线API向推荐服务发起请求，获得该用户可能感兴趣的物品，完成推荐业务。

## 基本概念

**客户/租户（org/tenant）**

指RecEng的使用者

**用户（user）**

RecEng使用者的用户

**物品（item）**

指被推荐给用户的内容

**业务（biz）**

一个客户在RecEng上可以有多个业务，不同的业务必然有不同的数据集。

RecEng要求每个业务提供四类数据（不要求全部提供）：

- 用户数据
- 物品数据
- 用户行为数据
- 推荐效果数据

每一组这样的数据就构成一个业务。

某客户A有两类被推荐的物品，分别是视频和歌曲，于是客户A可以在RecEng上建立**两个业务M和N，其中M的物品数据为视频，N的物品数据为歌曲，其他的数据（指用户数据，用户行为数据等）可以都相同**。在这种方案下，业务M和N的数据是独立的，即业务M虽然能看到用户对于歌曲的行为，但是业务M中不包含歌曲的物品数据，所以会丢弃用户对于歌曲的行为；**如果业务M中某用户只对歌曲有行为，对视频没有行为，业务M也会丢弃这类用户。反之对业务N亦然。**

**一个业务最好只推荐一类物品。多类物品的推荐在后续的行业模板会有支持**，需要引入板块(plate)的概念，一份业务数据可以生成多个板块的数据集，场景绑定某个板块进行推荐算法计算。

**场景（scn）**

一个业务可以包含多个场景。

场景由推荐时可用的参数决定。

首页推荐场景和详情页推荐场景。

每个场景都会输出一个API。

客户完全可以根据自己的需求建立全新的场景，比如针对搜索关键词的推荐场景，这时可用的参数除了用户信息，还有用户所输入的关键词。

**流程（flow）**

**一个场景只包含一个离线流程和一个近线流程，可以包含多个在线流程**，用于支持A/BTest。

- 离线流程

  离线流程的输入和输出都是MaxCompute（原ODPS）表。

- 近线流程

  推荐引擎的的近线流程主要处理用户行为发生变化、推荐物品发生更新时，对离线推荐结果进行更新。

  近线程序的输入数据可以来自多个数据源，如在线的表格存储（原OTS），以及用户的API请求，又或者是程序中的变量；输出可以是程序变量，或者写回在线存储，或者返回给用户。

  对于需要频繁使用的在线数据，无论其来自在线存储还是用户的API请求，RecEng会预先读好，保存在在线程序的变量中，客户自定义代码可以直接读写这些变量中的数据。

- 在线流程

  推荐引擎的的在线流程负责的任务是推荐API接收到API请求时，实时对离线和近线修正产生的推荐结果进行过滤、排重、补足等处理；后者主要处理用户行为发生变化、推荐物品发生更新时，对离线推荐结果进行更新

**算法策略（Algorithm Strategy）**

**作业/任务（task）**

作业指运行中的离线流程实例，作业和离线流程的关系完全等同于进程和程序的关系。每个作业都是不可重入的，即对每个离线流程，同一时间只允许运行一份实例。作业直接存在上下游关系，如果上游作业失败，下游任务也会被取消。

## 用户指南

### 业务列表

#### 概述

业务是推荐引擎中的基本管理单元，业务包含基本属性、数据和场景三类信息。

- 业务基本属性：包含业务code、业务名称、大数据计算资源和在线存储资源。
- 数据，定义了所能使用的数据范围。
- 场景，是指在您的APP或网站中使用推荐功能的模块。

#### 场景

- API参数设置：设置推荐API的入参都包含哪些参数。不同场景的入参是有可能不同的。例如做APP首页的『猜你喜欢』时，只需要传入用户ID；而在商品详情页做关联推荐时，还需要传入商品ID；若在类目下做推荐时，还需要传入类目ID等等。
- 在线流程设置：对『算法策略』中产生的多个结果集进行排序。例如：将基于因子分解的推荐结果集的排在前面，基于物品内容的推荐结果集放在次要，默认推荐的结果集（热榜等）放在最后。
- 指标设置：
  - 当测试整体流程完成，并将模型『上线』后，可在最左侧『线上』tab内找到相应的场景，查看『效果报表』，报表中的指标项即为本步骤中预设的『指标设置』
  - 确保您上传的行为表中，需要有与指标相对应的bhv_type（行为类型）。例如，若您想计算click_pv，那么需确保在行为表的bhv_type有click行为类型。
  - 确保您在收集行为日志埋点时，带上了trace_id字段信息。trace_id用于打穿从曝光、点击直到后续各转化环节的链路，例如当曝光行为、点击行为的trace_id相同时，则认为该点击是由该次曝光带来。
- API参数设置：
  - 设置推荐API的入参都包含哪些参数。不同场景的入参是有可能不同的。例如做APP首页的『猜你喜欢』时，只需要传入用户ID；而在商品详情页做关联推荐时，还需要传入商品ID；若在类目下做推荐时，还需要传入类目ID等等。
- 算法策略设置：
  - 可选择的算法策略：
    - 基于因子分解的推荐：基于因子分解将用户对物品的行为分解成用户特征向量和物品特征向量，再使用这些向量相乘得到用户推荐候选集和物品相关推荐候选集。
    - 基于内容的推荐：基于物品内容的推荐，主要通过物品的属性，描述，关键词，生成物品特征，进而计算物品相似度，然后基于用户行为和物品相似度来进行推荐。
    - 基于UserCF的协同过滤：基于用户行为，利用UserCF算法计算用户之间的相关性，再通过用户行为和用户相关性得到用户推荐候选集。
    - 基于ItemCF的协同过滤：基于用户行为，利用ItemCF算法计算物品之间的相关性，再通过用户行为和物品相关性得到用户推荐候选集。
    - 默认推荐：提供一类保底非个性化的推荐结果。按照算法策略参数来决定算法计算逻辑。其中：simple_pv，weighted_uv需要有用户行为数据，simple_recent，weighted_iteminfo，bucket_random则基于物品自身属性。
    - 带用户标签冷启动：离线根据用户tag产出用户分组，及分组的推荐物品（要求：行为数据丰富，能产出推荐结果集）。当新用户注册时，根据新用户的tag把用户归到相应分组中，并获取分组的推荐结果。
    - 不带标签的用户冷启动：根据物品属性特征对物品进行分组。采用EE算法实时计算用户对分组的偏好并进行推荐。数据要求：物品表中的物品可抽取特征。
    - 物品冷启动：离线对物品进行聚类分组（默认分20个组），并计算用户对每个聚类的偏好（要求离线行为比较丰富）。当有新物品注册时，实时计算物品特征并归到相应的物品分组中，根据用户对聚类的偏好，实时推荐新物品。
- 定时调度：
  - ​



## 数据格式规范 V3.0

### 数据格式规范 V3.0

推荐引擎的基础数据模型如下：

![dsp](http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/pic/54476/cn_zh/1496395260929/%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E8%A7%84%E8%8C%83.png)

- 每张表的表结构必须符合推荐引擎的要求，列名、字段类型和分区格式需要和规范中保持一致。
- 以下几张表中必须有数据：用户信息表、物品信息表、用户行为表。
- 业务数据中无法提供的字段可以填NULL。
- **每张表都必须是分区表**，以’**yyyyMMdd’格式的字符型字段ds**作为分区字段。
- 除了行为表需要每日上传外，其他meta表如果不发生变化可以不导，推荐引擎会自动获取**最近一个有数据的分区中的meta表数据**进行算法计算。
- 如果未传可推荐物品表，则将物品表全量作为可推荐物品表，继承item_info 字段。

> USER_META、USER_META_CONFIG、ITEM_META、ITEM_META_CONFIG中的ds最大值分区是指：该表中所有存在的ds分区取值中按字符串字典序升序排序最大的那个值（不是数据条数最多、数据存储量最大等其他意义上的最大）。举例来说，假设有三个分区20171010、20171110和20171210，推荐引擎实际在做数据预处理时会使用MaxCompute SQL的max_pt函数，取到的是20171210这个单一分区里的全量数据，对于其他分区会完全忽视，也不会进行任何的合并、去重操作。还有需要注意的是，由于这里取的仅仅是字典序最大的那个分区，而不是字典序最大且“有数据”的那个分区，因此对于这个最大分区里的数据完整性、规范性需要您自行保证。

### 用户表（USER_META）

字段描述

| 列名      | 注释                                       |
| ------- | ---------------------------------------- |
| user_id | 用户ID， 不能出现(\001-\003)特殊字符。               |
| tags    | 标签-标签值kv串。 不同tag之间用\002分隔。 tag和value之间用\003分隔。 例子：比如用户有两个标签年龄和性别： age\00318\002gender\0031。 |
| plates  | **？？？**。 板块区分字段，多个板块code用逗号分隔。           |

### 用户属性维度表 （USER_META_CONFIG）

| 列名           | 注释                                       |
| ------------ | ---------------------------------------- |
| config_name  | user_meta 表tags中的key，每个key一条记录           |
| config_value | 标签取值类型。mv_enum：多值枚举型；kv_num ：数值型；sv_enum： 单值枚举型；sv_num， 单值数值型； |

> 特征的数值类型分为mv_enum，kv_num，sv_enum，sv_num，分别代表多值枚举型，KV数值型，单值枚举型，单值数值型四种标签取值类型
> 举例：
> 单值数值型，如信用，只能取一个值，但这个值是不可枚举的
> 单值枚举型，如性别，只能取一个值，但这个值是可以枚举的（男，女）
> KV数值型，如用户的类目偏好，用户对某几个类目有偏好分，如3298:0.89,3456:0.98..这里3298和3456是类目id，0.89和0.98是偏好分
> 多值枚举型，如用户的标签，美包控、准妈妈等可以枚举，但是每个用户可以取多个
> 在特征串中，不同key之间用\002分隔，key和value之间用\003分隔，多值key的value之间用\004连接。以上述4个例子为例，如果把它们串起来，则形式为    
>
>             信用 \003 98 
>           \002 
>           性别 \003 男 
>           \002
>           类目偏好 \003 3298 \004 0.89 \003 3456 \004 0.98
>           \002
>           标签 \003 美包控 \003 准妈妈

### 物品表（ITEM_META）

字段描述

| 列名              | 注释                                       |
| --------------- | ---------------------------------------- |
| item_id         | 物品ID，唯一标识                                |
| category        | 物品所属类目，最好以ID的形式给出。只支持单类目。如果要表示多分类，在properties中描述 |
| keywords        | 关键词串。关键词可以有权重（需要归一化到0-1之间），也可以没有权重，没有权重时所有词的权重都是1。Keywords之间用\002分隔，keyword和score之间用\003分隔（如果score存在）基本格式：kw1\003s1\002kw2\003\s2\002… |
| description     | 文本。友佳说，支持分词。                             |
| properties      | 属性-属性值kv串。不同key之间用\002分隔，key和value之间用\003分隔。不同property的key最好以ID的形式给出。基本格式：k1\003v1\002k2\003v2…]。 比如电影作为item，properties中的key包括演员、风格，取值分别为巩俐、爱情剧，这条记录的properties字段可以编码为actor\003Gong Li\002style\003Love。 |
| item_info       | 物品的业务信息，KV格式。不同KV之间以\002分隔，key和value之间以\003分隔。 item_info和properties的区别在item_info不参与特征提取的计算 |
| update_datetime | 物品更新时间                                   |
| plates          |                                          |

### 物品属性维度表 （ITEM_META_CONFIG）

同 用户属性维度表 （USER_META_CONFIG）

### 行为表（USER_BEHAVIOR）

字段描述

| 列名           | 注释                                       |
| ------------ | ---------------------------------------- |
| user_id      | 用户ID                                     |
| act_obj      | 行为对象，行为作用对象的标识,如果有ID，就用ID，如帖子的作者；如果没有ID，直接记录，如搜索关键词 |
| obj_type     | 行为作用对象的类型。取值范围： item：行为对象就是物品，这时act_obj就是item_idcategory：行为对象是物品的类型，这时act_obj一般都是category idproperty：行为对象是物品的属性，这时要说明具体属性在properties字段中的key。这种情况下本字段格式为properties:keykeyword：行为对象是关键词,默认为‘item’。 |
| bhv_type     | 行为类型：view：物品曝光click：用户点击物品collect：用户收藏了某个物品uncollect：用户取消收藏某个物品search_click：用户点击搜索结果中的物品comment：用户对物品的评论share: 分享like：点赞dislike：点衰grade：评分consume：消费use：观看视频/听音乐/阅读行为表记录的用户行为用于用户偏好建模。 |
| bhv_amt      | 用户对物品的评分、消费、观看时长等。                       |
| bhv_cnt      | 行为次数，默认为1，消费可以埋购买件数。                     |
| bhv_datetime | 行为发生的时间，UTC格式。                           |
| content      | 行为的具体内容。comment：记录评论search_click：记录搜索关键字。 |
| pos_type     | 行为发生的位置类型，和下面position字段联合使用，有三种取值：ll：经纬度格式的位置信息gh：geohash格式的位置信息poi：poi格式的位置信息 |
| position     | 行为发生的位置，根据pos_type有不同的取值格式：如果pos_type=ll，position格式[longitude:latitude] 如果pos_type=gh，position格式[geohashcode]如果pos_type=poi，position格式[poi_string] |
| env          | JSON String{“IP”:””,“network”:””,“device”:””}IP: IP地址。行为发生时用户的IP地址。IPv4为点分十进制格式；IPv6为冒号分隔的标准6段格式（不使用IPv6嵌套IPv4的格式）network: 网络制式。行为发生时用户所使用的接入网络，取值为solid，2G，3G，4G，WIFI。分别表示固网，2G，3G，4G和WIFI接入方式device: 发生行为所使用的设备，包括mobile，pad，pc等，可添加其他自定义环境变量也可以添加到JSON中 |
| trace_id     | 返回的推荐列表用于跟踪效果。如果对item_id 的行为不是来自推荐引导，则为NULL |
| plates       |                                          |

### 可推荐物品表（REC_ITEM_INFO）

| 列名        | 注释                                       |
| --------- | ---------------------------------------- |
| item_id   | 物品ID，唯一标识。本表中的物品都是允许被推荐的物品。              |
| item_info | 如果业务方希望RecEng在返回推荐物品时同时返回物品的其他信息，保存在这里。RecEng不需要了解item_info的内部格式，原样返回给业务方。 |
| class     | 分组信息,用于多分类推荐,多个取值之间用\002分割               |
| plates    |                                          |

### 朋友关系表（USER_RELATIONSHIP）

| 列名       | 注释                                       |
| -------- | ---------------------------------------- |
| user_id  | 用户ID                                     |
| follow   | 用户-亲密度KV串。KV串中每个key为当前用户关注的某个用户的user_id，value为亲密度的评分。KV组之间以\002分隔，key和value之间以\003分隔 |
| followby | 用户-亲密度KV串。KV串中每个key为当前用户关注的某个用户的user_id，value为亲密度的评分。KV组之间以\002分隔，key和value之间以\003分隔 |
| plates   |                                          |

## 算法策略

### 基于内容的推荐

**输入数据**

| 数据               | 描述      |
| ---------------- | ------- |
| USER_BEHAVIOR    | 离线用户行为表 |
| REC_ITEM_INFO    | 可推荐物品表  |
| ITEM_META        | 物品表     |
| ITEM_META_CONFIG | 物品信息维度表 |

**输出数据**

| 数据                               | 描述                                       |
| -------------------------------- | ---------------------------------------- |
| OFFLINE_USER_ITEM_REC            | 用户对物品的推荐候选集（离线产出）。基于离线用户历史存量行为（一般是过去N天，N在算法参数里可以配置）产出的“综合”推荐结果，即在“全局的推荐池”里基于用户对物品的预测打分进行Top召回，这里建模的是用户的“中长期兴趣”。 |
| OFFLINE_MULTICLASS_USER_ITEM_REC | 不同分类下的用户对物品推荐候选集（离线产出）。用于带限制条件下的用户推荐（如在指定类目、关键词下对用户进行推荐），不同于上面第一条推荐结果，这个推荐是在一个“按指定条件筛选后的、缩小的推荐池”里进行推荐召回。 |
| OFFLINE_ITEM_ITEM_REC            | 基于物品行为相似度产生的相似物品列表（离线产出）。可以实现在物品详情页的关联推荐（如”看过该物品的用户还看了“) |
| OFFLINE_MULTICLASS_ITEM_ITEM_REC | 不同分类下的物品对物品推荐候选集（离线产出）。用于带限制条件的物品关联推荐（如指定类目、关键词等），一般情况下不用，可以实现一些简单的“跨分类搭配购买”策略，如通过事先的数据分析发现母婴类目和酒水类目是一个频繁项集，则可以在用户购买了尿布之后为他推荐啤酒。 |

